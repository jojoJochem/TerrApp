<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Excel → Word Tabel Generator</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <main class="page">
    <header class="topbar">
      <div class="brand">
        <img class="brand__logo" src="{{ url_for('static', filename='Terrascan.png') }}" alt="Terrascan">
        <div class="brand__text">
          <h1>Excel → Word Tabel Generator</h1>
          <p>Upload één of meerdere Toetsing Excel-bestanden en genereer direct een Word-document.</p>
        </div>
      </div>
    </header>

    {% if error_message %}
      <div class="modal" id="errorModal" role="dialog" aria-modal="true" aria-labelledby="errorTitle" aria-describedby="errorBody">
        <div class="modal__card modal__card--error">
          <div class="modal__header">
            <h2 id="errorTitle">{{ error_title or "Bad Request" }}</h2>
          </div>
          <p id="errorBody">{{ error_message }}</p>
          <div class="modal__actions">
            <button class="btn btn--ghost" type="button" id="errorOk">Ok</button>
          </div>
        </div>
      </div>
    {% endif %}

    <section class="card">
      <form action="{{ url_for('generate') }}" method="post" enctype="multipart/form-data" class="form" id="uploadForm">
        <label class="dropzone" for="fileInput" id="dropzone">
          <input
            id="fileInput"
            class="dropzone__input"
            type="file"
            name="files"
            multiple
            accept=".xlsx,.xlsm,.xls"
          />

          <div class="dropzone__content">
            <div class="dropzone__icon" aria-hidden="true">⬆</div>
            <div class="dropzone__title">Sleep je bestanden hierheen</div>
            <div class="dropzone__subtitle">Meerdere bestanden toegestaan</div>
          </div>

          <div class="dropzone__meta">
            <span class="pill">of klik om te kiezen (.xlsx / .xlsm / .xls)</span>
          </div>
        </label>

        <div class="row">
          <div class="hint">
            <strong>Uitvoer</strong>
            <div class="hint__text">
              1 Word-document (.docx) met twee tabellen:<br>
              <span class="muted">Tabel 1. Samenstelling analysemonsters</span><br>
              <span class="muted">Tabel 2. Samenvatting toetsing milieuhygiënische kwaliteit grond</span>
            </div>
          </div>

          <button class="btn" type="submit" id="generateBtn">Genereer Word-document</button>
        </div>

        <div class="filelist" id="fileList" aria-live="polite"></div>
      </form>
    </section>

    <footer class="footer">
      <small>Laatst bijgewerkt: <span class="mono">{{ last_update }}</span></small>
    </footer>
  </main>

  <script>
    const form = document.getElementById("uploadForm");
    const input = document.getElementById("fileInput");
    const list = document.getElementById("fileList");
    const dropzone = document.getElementById("dropzone");
    const generateBtn = document.getElementById("generateBtn");

    let filesStore = [];

    function fileKey(f) {
      return `${f.name}__${f.size}__${f.lastModified}`;
    }

    function addFiles(newFiles) {
      const map = new Map(filesStore.map(f => [fileKey(f), f]));
      for (const f of newFiles) map.set(fileKey(f), f);
      filesStore = Array.from(map.values());
    }

    function syncInputFiles() {
      const dt = new DataTransfer();
      filesStore.forEach(f => dt.items.add(f));
      input.files = dt.files;
    }

    function renderFiles() {
      updateGenerateHint();
      if (filesStore.length === 0) {
        list.innerHTML = "";
        return;
      }

      const items = filesStore.map((f, idx) => {
        const sizeKB = Math.round(f.size / 1024);
        return `
          <div class="file">
            <div class="file__name" title="${f.name}">${f.name}</div>
            <div class="file__size">${sizeKB.toLocaleString("nl-NL")} KB</div>
            <button
              type="button"
              class="file__remove"
              aria-label="Verwijder ${f.name}"
              data-index="${idx}"
              title="Verwijder"
            >✕</button>
          </div>
        `;
      });

      list.innerHTML =
        `<div class="filelist__title">Geselecteerde bestanden</div>${items.join("")}`;

      document.querySelectorAll(".file__remove").forEach(btn => {
        btn.addEventListener("click", () => {
          const index = Number(btn.dataset.index);
          filesStore.splice(index, 1);
          syncInputFiles();
          renderFiles();
        });
      });
    }
    function updateGenerateHint() {
      if (!generateBtn) return;
      if (filesStore.length === 0) {
        generateBtn.classList.add("has-tooltip");
        generateBtn.setAttribute("data-tooltip", "Voeg eerst een Excel-bestand toe");
      } else {
        generateBtn.classList.remove("has-tooltip");
        generateBtn.removeAttribute("data-tooltip");
      }
    }

    form.addEventListener("submit", (e) => {
      syncInputFiles();
      if (filesStore.length === 0 || input.files.length === 0) {
        e.preventDefault();
        list.innerHTML = `<div class="filelist__title" style="color:#dc2626;">Selecteer minimaal één bestand.</div>`;
      }
    });

    input.addEventListener("click", () => {
      input.value = "";
    });

    input.addEventListener("change", (e) => {
      addFiles(Array.from(e.target.files));
      syncInputFiles();
      renderFiles();
    });

    ["dragenter", "dragover"].forEach(evt =>
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add("is-dragover");
      })
    );

    ["dragleave", "drop"].forEach(evt =>
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove("is-dragover");
      })
    );

    dropzone.addEventListener("drop", (e) => {
      const dt = e.dataTransfer;
      if (!dt?.files?.length) return;

      addFiles(Array.from(dt.files));
      syncInputFiles();
      renderFiles();
    });

    form.addEventListener("submit", () => {
      setTimeout(() => {
        filesStore = [];
        input.value = "";
        list.innerHTML = "";
        updateGenerateHint();
      }, 100);
    });

    updateGenerateHint();

    const errorModal = document.getElementById("errorModal");
    if (errorModal) {
      const closeButtons = errorModal.querySelectorAll(".modal__close, #errorOk");
      closeButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          errorModal.remove();
        });
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          errorModal.remove();
        }
      });
    }
  </script>
</body>
</html>
